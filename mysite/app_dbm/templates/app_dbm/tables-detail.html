{% extends 'base.html' %}
{% load static %}
{% block title %}{{ title }}{% endblock title %}

{% block body %}
<style>
    /* === СТИЛИ === */
    :root {
        --primary-dark: #1a1a1a;
        --primary-yellow: #ffcc00;
        --yellow-light: #fff9e6;
        --yellow-dark: #e6b800;
        --text-dark: #333;
        --text-light: #f8f9fa;
        --success-color: #28a745;
        --info-color: #17a2b8;
        --warning-color: #ffc107;
    }

    .container-content {
        width: 90%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px 0;
    }

    .data-card {
        border: 2px solid var(--primary-yellow);
        border-radius: 10px;
        margin-bottom: 25px;
        background: white;
        overflow: hidden;
    }

    .data-card-header {
        background: linear-gradient(135deg, var(--primary-dark), #2a2a2a);
        color: var(--primary-yellow);
        padding: 20px;
        border-bottom: 2px solid var(--primary-yellow);
    }

    .accordion-header {
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    .accordion-header:hover {
        background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
    }

    .accordion-arrow {
        color: var(--primary-yellow);
        font-size: 1.2rem;
        transition: transform 0.3s ease;
        display: inline-block;
    }

    .accordion-header.collapsed .accordion-arrow {
        transform: rotate(-90deg);
    }

    .data-card-body {
        padding: 20px;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 14px;
        border-bottom: 1px solid #eee;
        vertical-align: top;
    }

    .data-table thead th {
        background: #1a1a1a;
        color: #ffcc00;
    }

    .badge-yellow {
        background: #ffcc00;
        color: #1a1a1a;
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 600;
    }

    .badge-null {
        background: #6c757d;
        color: white;
        padding: 4px 10px;
        border-radius: 4px;
    }

    .badge-not-null {
        background: var(--success-color);
        color: white;
        padding: 4px 10px;
        border-radius: 4px;
    }

    .stage-badge {
        background: #e9ecef;
        padding: 4px 8px;
        border-radius: 10px;
        margin: 2px;
        display: inline-block;
        font-size: 0.8rem;
    }

    .relations-container {
        min-width: 250px;
    }

    .relation-item {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px dashed #eee;
    }

    .relation-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .relation-type {
        display: inline-block;
        font-size: 0.75rem;
        padding: 2px 6px;
        border-radius: 4px;
        margin-right: 6px;
        font-weight: 600;
    }

    .relation-type-foreign {
        background-color: #d1ecf1;
        color: #0c5460;
    }

    .relation-type-update {
        background-color: #d4edda;
        color: #155724;
    }

    .relation-link {
        display: block;
        margin-top: 4px;
        color: var(--primary-dark);
        text-decoration: none;
    }

    .relation-link:hover {
        color: var(--primary-yellow);
        text-decoration: underline;
    }

    .no-relations {
        color: #6c757d;
        font-style: italic;
    }

    .service-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        height: 100%;
        transition: transform 0.2s, box-shadow 0.2s;
        background: white;
    }

    .service-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: var(--primary-yellow);
    }

    .service-name {
        color: var(--primary-dark);
        font-weight: 600;
        margin-bottom: 8px;
    }

    .service-description {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .service-owner {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
        font-size: 0.85rem;
    }

    .service-owner-label {
        color: #6c757d;
    }

    .service-owner-name {
        color: var(--primary-dark);
        font-weight: 500;
    }
</style>

<div class="container-fluid bg-light min-vh-100">
    <div class="container-content">
        <!-- ===================== ОСНОВНАЯ ИНФОРМАЦИЯ ===================== -->
        <div class="data-card">
            <div class="data-card-header">
                <h5>
                    {{ tables.schema.base.name|upper }}-{{ tables.schema.schema|upper }}-{{ tables.name|upper }}
                </h5>
            </div>
            <div class="data-card-body">
                {{ tables.description }}
            </div>
        </div>
        <!-- ===================== СВЯЗАННЫЕ СЕРВИСЫ (АККОРДЕОН) ===================== -->
        {% if services_list %}
        <div class="data-card">
            <div class="data-card-header accordion-header d-flex justify-content-between align-items-center collapsed"
                 data-bs-toggle="collapse"
                 data-bs-target="#servicesAccordion"
                 aria-expanded="false"
                 aria-controls="servicesAccordion">
                <h5 class="mb-0">
                    Связанные сервисы
                    <span class="badge-yellow ms-2">{{ services_count }}</span>
                </h5>
                <span class="accordion-arrow">▼</span>
            </div>

            <div id="servicesAccordion" class="collapse">
                <div class="data-card-body">
                    <div class="row">
                        {% for service in services_list %}
                        <div class="col-md-4 mb-3">
                            <div class="service-card">
                                <div class="service-name">
                                    <a href="{% url 'app_services:services-detail' pk=service.service.pk %}" class="relation-link">
                                        {{ service.service.alias }}
                                    </a>
                                </div>
                                {% if service.service.description %}
                                <div class="service-description">
                                    {{ service.service.description|truncatechars:120 }}
                                </div>
                                {% endif %}
                                {% if service.service.owner %}
                                <div class="service-owner">
                                    <span class="service-owner-label">Ответственный:</span>
                                    <div class="service-owner-name">{{ service.service.owner }}</div>
                                </div>
                                {% endif %}

                                {% if service.service.type %}
                                <div class="mt-2">
                                    <span class="badge bg-secondary">{{ service.service.type }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ===================== КОЛОНКИ ТАБЛИЦЫ ===================== -->
        <div class="data-card">
            <div class="data-card-header">
                <h5>
                    Колонки таблицы
                    <span class="badge-yellow">{{ columns|length }}</span>
                </h5>
            </div>

            <div class="data-card-body p-0">
                <table class="data-table">
                    <thead>
                    <tr>
                        <th>№</th>
                        <th>Колонка</th>
                        <th>Тип</th>
                        <th>NULL</th>
                        <th>Описание</th>
                        <th>Связи и обновления</th>
                        <th>Стадии</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for col in columns %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td><strong>{{ col.columns }}</strong></td>
                        <td><code>{{ col.type }}</code></td>
                        <td>
                            {% if col.is_null %}
                            <span class="badge-null">NULL</span>
                            {% else %}
                            <span class="badge-not-null">NOT_NULL</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if col.description %}
                            {% for k, v in col.description.items %}
                            <div><strong>{{ k }}:</strong> {{ v }}</div>
                            {% endfor %}
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>

                        <!-- ===== ОБЪЕДИНЕННЫЙ СТОЛБЕЦ СВЯЗИ И ОБНОВЛЕНИЯ ===== -->
                        <td>
                            <div class="relations-container">
                                <!-- Связи (foreign keys) -->
                                {% for r in column_relations %}
                                {% if r.main == col and r.sub %}
                                <div class="relation-item">
                                    <a href="{% url 'dbm:tables-detail' pk=r.sub.table.pk %}" class="relation-link">
                                        {{ r.type.name }}: {{ r.sub.table.name }}.{{ r.sub.columns }}
                                    </a>
                                </div>
                                {% endif %}
                                {% endfor %}
                                <!-- Обновления (updates) -->
                                {% for upd in update_columns %}
                                {% if upd.main_id == col.id %}
                                <div class="relation-item">
                                    {% if upd.sub %}
                                    <a href="{% url 'app_updates:updates-detail' pk=upd.type.pk %}" class="relation-link">
                                        update: {{ upd.type }}
                                    </a>
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endfor %}

                                <!-- Если нет ни связей, ни обновлений -->
                                {% with total_relations=column_relations|length total_updates=update_columns|length %}
                                {% if not column_relations and not update_columns %}
                                <div class="no-relations">—</div>
                                {% endif %}
                                {% endwith %}
                            </div>
                        </td>

                        <td>
                            {% if col.stages_from_json %}
                            {% for stage in col.stages_from_json %}
                            <span class="stage-badge">{{ stage }}</span>
                            {% endfor %}
                            {% else %}
                            —
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Анимация стрелки аккордеона
        const accordionHeaders = document.querySelectorAll('.accordion-header');

        accordionHeaders.forEach(header => {
            // Инициализируем начальное положение стрелки
            const arrow = header.querySelector('.accordion-arrow');
            if (header.classList.contains('collapsed')) {
                arrow.style.transform = 'rotate(-90deg)';
            } else {
                arrow.style.transform = 'rotate(0deg)';
            }
        });
    });
</script>
{% endblock body %}