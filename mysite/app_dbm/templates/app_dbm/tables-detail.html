{% extends 'base.html' %}
{% load static %}
{% block title %}{{ title }}{% endblock title %}
{% block body %}
<style>
    /* === –û–°–ù–û–í–ù–´–ï –°–¢–ò–õ–ò === */
    :root {
        --primary-dark: #1a1a1a;
        --primary-yellow: #ffcc00;
        --yellow-light: #fff9e6;
        --yellow-dark: #e6b800;
        --text-dark: #333;
        --text-light: #f8f9fa;
        --success-color: #28a745;
        --info-color: #17a2b8;
        --warning-color: #ffc107;
    }

    .container-content {
        width: 90%;
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px 0;
    }

    .data-card {
        border: 2px solid var(--primary-yellow);
        border-radius: 10px;
        margin-bottom: 20px;
        background: white;
        overflow: hidden;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    }

    .data-card-header {
        background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        color: white;
        padding: 15px 20px;
        border-bottom: 2px solid var(--primary-yellow);
    }

    /* === –ö–û–ú–ü–ê–ö–¢–ù–´–ô –ó–ê–ì–û–õ–û–í–û–ö –¢–ê–ë–õ–ò–¶–´ === */
    .table-header-compact {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
    }

    .table-basic-info {
        flex: 1;
        min-width: 0;
    }

    .table-title-row {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 8px;
        flex-wrap: wrap;
    }

    .table-name-main {
        color: var(--primary-yellow);
        font-size: 1.5rem;
        font-weight: 700;
        letter-spacing: 0.5px;
        text-transform: uppercase;
    }

    .table-meta-badges {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
    }

    .meta-badge {
        display: inline-flex;
        align-items: center;
        gap: 5px;
        padding: 4px 10px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        font-size: 0.85rem;
        border: 1px solid rgba(255, 204, 0, 0.2);
    }

    .meta-badge .badge-icon {
        color: var(--primary-yellow);
        font-size: 0.9rem;
    }

    .meta-badge .badge-text {
        color: white;
        font-weight: 600;
    }

    .table-description-line {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.95rem;
        line-height: 1.4;
        margin-top: 5px;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    .export-actions {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 5px;
        flex-shrink: 0;
    }

    .btn-export-compact {
        background: linear-gradient(135deg, var(--primary-yellow), #ffaa00);
        color: var(--primary-dark);
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-weight: 700;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        align-items: center;
        gap: 8px;
        white-space: nowrap;
        box-shadow: 0 2px 8px rgba(255, 204, 0, 0.3);
    }

    .btn-export-compact:hover {
        background: linear-gradient(135deg, #ffd633, #ffcc00);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 204, 0, 0.4);
    }

    .btn-export-compact:active {
        transform: translateY(0);
    }

    .export-icon {
        font-size: 1rem;
    }

    .export-hint {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.75rem;
        text-align: right;
        max-width: 120px;
        line-height: 1.2;
    }

    /* === –û–°–¢–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò === */
    .data-card-body {
        padding: 20px;
    }

    .accordion-header {
        cursor: pointer;
        transition: background-color 0.3s ease;
        padding: 15px 20px;
    }

    .accordion-header:hover {
        background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
    }

    .accordion-arrow {
        color: var(--primary-yellow);
        font-size: 1.2rem;
        transition: transform 0.3s ease;
        display: inline-block;
    }

    .accordion-header.collapsed .accordion-arrow {
        transform: rotate(-90deg);
    }

    .badge-yellow {
        background: var(--primary-yellow);
        color: var(--primary-dark);
        padding: 4px 10px;
        border-radius: 20px;
        font-weight: 700;
        font-size: 0.9rem;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã */
    .data-table-container {
        overflow-x: auto;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
    }

    .data-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 800px;
    }

    .data-table th {
        background: linear-gradient(135deg, #2a2a2a, #3a3a3a);
        color: var(--primary-yellow);
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.9rem;
        letter-spacing: 0.5px;
        padding: 12px 15px;
        border-bottom: 2px solid var(--primary-yellow);
        text-align: left;
    }

    .data-table td {
        padding: 12px 15px;
        border-bottom: 1px solid #f0f0f0;
        vertical-align: top;
        background: white;
    }

    .data-table tbody tr:hover td {
        background: #f9f9f9;
    }

    .data-table tbody tr:nth-child(even) td {
        background: #f8f8f8;
    }

    .data-table tbody tr:nth-child(even):hover td {
        background: #f0f0f0;
    }

    .badge-null {
        background: #dc3545;
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .badge-not-null {
        background: var(--success-color);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .stage-badge {
        background: #e9ecef;
        color: #495057;
        padding: 4px 8px;
        border-radius: 10px;
        margin: 2px;
        display: inline-block;
        font-size: 0.8rem;
        font-weight: 500;
        border: 1px solid #dee2e6;
    }

    .relations-container {
        min-width: 200px;
        max-width: 250px;
    }

    .relation-item {
        margin-bottom: 8px;
        padding-bottom: 8px;
        border-bottom: 1px dashed #e0e0e0;
    }

    .relation-item:last-child {
        margin-bottom: 0;
        padding-bottom: 0;
        border-bottom: none;
    }

    .relation-link {
        display: block;
        color: #0066cc;
        text-decoration: none;
        font-size: 0.9rem;
        line-height: 1.3;
        transition: color 0.2s;
    }

    .relation-link:hover {
        color: var(--primary-yellow);
        text-decoration: underline;
    }

    .no-relations {
        color: #6c757d;
        font-style: italic;
        font-size: 0.9rem;
    }

    /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–µ—Ä–≤–∏—Å–æ–≤ */
    .service-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        height: 100%;
        transition: all 0.3s ease;
        background: white;
        border-left: 4px solid var(--primary-yellow);
    }

    .service-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 15px rgba(0,0,0,0.1);
        border-color: var(--primary-yellow);
    }

    .service-name {
        color: var(--primary-dark);
        font-weight: 700;
        margin-bottom: 8px;
        font-size: 1.1rem;
    }

    .service-description {
        color: #666;
        font-size: 0.9rem;
        line-height: 1.4;
        margin-bottom: 10px;
    }

    .service-owner {
        margin-top: 10px;
        padding-top: 10px;
        border-top: 1px solid #eee;
        font-size: 0.85rem;
    }

    .service-owner-label {
        color: #6c757d;
        font-weight: 600;
    }

    .service-owner-name {
        color: var(--primary-dark);
        font-weight: 500;
    }

    /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ */
    .export-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background: var(--success-color);
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1000;
        display: none;
        align-items: center;
        gap: 10px;
        animation: slideIn 0.3s ease;
        font-weight: 500;
        border: 1px solid rgba(255,255,255,0.2);
    }

    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
    @media (max-width: 768px) {
        .table-header-compact {
            flex-direction: column;
            align-items: stretch;
            gap: 10px;
        }

        .table-title-row {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }

        .export-actions {
            align-items: stretch;
            margin-top: 10px;
        }

        .btn-export-compact {
            justify-content: center;
        }

        .export-hint {
            text-align: center;
            max-width: none;
        }

        .data-card-header {
            padding: 15px;
        }

        .table-name-main {
            font-size: 1.3rem;
        }
    }

    @media (max-width: 480px) {
        .table-meta-badges {
            flex-direction: column;
            align-items: flex-start;
        }

        .meta-badge {
            width: 100%;
            justify-content: space-between;
        }

        .container-content {
            width: 95%;
            padding: 10px 0;
        }
    }
</style>
<div class="container-fluid bg-light min-vh-100">
    <div class="container-content">
        <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —ç–∫—Å–ø–æ—Ä—Ç–µ -->
        <div class="export-notification" id="exportNotification">
            <span>‚úÖ</span>
            <span>–¢–∞–±–ª–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ CSV!</span>
        </div>
        <!-- ===================== –û–°–ù–û–í–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø ===================== -->
        <div class="data-card">
            <div class="data-card-header">
                <div class="table-header-compact">
                    <div class="table-basic-info">
                        <div class="table-title-row">
                            <span class="meta-badge"
                                  style="background-color: #ffcc00; color: #1a1a1a;
                                  font-weight: bold; padding: 4px 8px; border-radius: 4px; display: inline-block;
                                   margin-right: 5px;">{{ tables.schema.base.name|upper }}
                            </span>
                            <span class="meta-badge"
                                  style="background-color: #ffcc00; color: #1a1a1a;
                                  font-weight: bold; padding: 4px 8px; border-radius: 4px; display: inline-block;
                                  margin-right: 5px;">{{ tables.schema.schema|upper }}
                            </span>
                            <span class="meta-badge"
                                  style="background-color: #ffcc00; color: #1a1a1a;
                                  font-weight: bold; padding: 4px 8px; border-radius: 4px; display: inline-block;
                                   margin-right: 5px;">{{ tables.name|upper }}
                            </span>
                            <span class="meta-badge">{{ tables.type }}</span>
                        </div>
                        {% if tables.description %}
                        <div class="table-description-line" title="{{ tables.description }}">
                            {{ tables.description|truncatechars:120 }}
                        </div>
                        {% endif %}
                    </div>

                    <div class="export-actions">
                        <button id="exportCsvBtn" class="btn-export-compact">
                            <span class="export-icon">üì•</span>
                            –≠–∫—Å–ø–æ—Ä—Ç CSV
                        </button>
                        <div class="export-hint">
                            –≠–∫—Å–ø–æ—Ä—Ç —Ç–∞–±–ª–∏—Ü—ã –∫–æ–ª–æ–Ω–æ–∫
                        </div>
                    </div>
                </div>
            </div>
            {% if tables.description and tables.description|length > 120 %}
            <div class="data-card-body" style="padding-top: 0;">
                <p class="text-muted mb-0">
                    <small>–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ: {{ tables.description }}</small>
                </p>
            </div>
            {% endif %}
        </div>
        <!-- ===================== –°–í–Ø–ó–ê–ù–ù–´–ï –°–ï–†–í–ò–°–´ (–ê–ö–ö–û–†–î–ï–û–ù) ===================== -->
        {% if services_list %}
        <div class="data-card">
            <div class="data-card-header accordion-header d-flex justify-content-between align-items-center collapsed"
                 data-bs-toggle="collapse"
                 data-bs-target="#servicesAccordion"
                 aria-expanded="false"
                 aria-controls="servicesAccordion">
                <h5 class="mb-0">
                    <span>üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã</span>
                    <span class="badge-yellow ms-2">{{ services_count }}</span>
                </h5>
                <span class="accordion-arrow">‚ñº</span>
            </div>

            <div id="servicesAccordion" class="collapse">
                <div class="data-card-body">
                    <div class="row">
                        {% for service in services_list %}
                        <div class="col-md-4 mb-3">
                            <div class="service-card">
                                <div class="service-name">
                                    <a href="{% url 'app_services:services-detail' pk=service.service.pk %}"
                                       class="relation-link">
                                        {{ service.service.alias }}
                                    </a>
                                </div>
                                {% if service.service.description %}
                                <div class="service-description">
                                    {{ service.service.description|truncatechars:120 }}
                                </div>
                                {% endif %}
                                {% if service.service.owner %}
                                <div class="service-owner">
                                    <span class="service-owner-label">–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π:</span>
                                    <div class="service-owner-name">{{ service.service.owner }}</div>
                                </div>
                                {% endif %}

                                {% if service.service.type %}
                                <div class="mt-2">
                                    <span class="badge bg-secondary">{{ service.service.type }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        <!-- ===================== –ö–û–õ–û–ù–ö–ò –¢–ê–ë–õ–ò–¶–´ ===================== -->
        <div class="data-card">
            <div class="data-card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <span>üìã –ö–æ–ª–æ–Ω–∫–∏ —Ç–∞–±–ª–∏—Ü—ã</span>
                    <span class="badge-yellow ms-2">{{ columns|length }}</span>
                </h5>
                <small class="text-white-50">
                    –í—Å–µ–≥–æ –∫–æ–ª–æ–Ω–æ–∫: {{ columns|length }}
                </small>
            </div>

            <div class="data-table-container">
                <table class="data-table" id="columnsTable">
                    <thead>
                    <tr>
                        <th style="width: 50px;">#</th>
                        <th style="min-width: 150px;">–ö–æ–ª–æ–Ω–∫–∞</th>
                        <th style="min-width: 100px;">–¢–∏–ø</th>
                        <th style="width: 80px;">NULL</th>
                        <th style="min-width: 200px;">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                        <th style="min-width: 250px;">–°–≤—è–∑–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è</th>
                        <th style="min-width: 150px;">–°—Ç–∞–¥–∏–∏</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for col in columns %}
                    <tr>
                        <td><strong>{{ forloop.counter }}</strong></td>
                        <td><strong class="text-dark">{{ col.columns }}</strong></td>
                        <td><code class="bg-light p-1 rounded">{{ col.type }}</code></td>
                        <td>
                            {% if col.is_null %}
                            <span class="badge-null">NULL</span>
                            {% else %}
                            <span class="badge-not-null">NOT_NULL</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if col.description %}
                            {% if col.description.items %}
                            {% for k, v in col.description.items %}
                            <div><strong>{{ k }}:</strong> {{ v }}</div>
                            {% endfor %}
                            {% else %}
                            {{ col.description }}
                            {% endif %}
                            {% else %}
                            <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>

                        <!-- ===== –°–í–Ø–ó–ò –ò –û–ë–ù–û–í–õ–ï–ù–ò–Ø ===== -->
                        <td>
                            <div class="relations-container">
                                <!-- –°–≤—è–∑–∏ (foreign keys) -->
                                {% for r in column_relations %}
                                {% if r.main == col and r.sub %}
                                <div class="relation-item">
                                    <a href="{% url 'app_dbm:tables-detail' pk=r.sub.table.pk %}" class="relation-link">
                                        üîó {{ r.type.name }}: {{ r.sub.table.name }}.{{ r.sub.columns }}
                                    </a>
                                </div>
                                {% endif %}
                                {% endfor %}
                                <!-- –û–±–Ω–æ–≤–ª–µ–Ω–∏—è (updates) -->
                                {% for upd in update_columns %}
                                {% if upd.main_id == col.id %}
                                <div class="relation-item">
                                    {% if upd.type %}
                                    <span class="text-muted">üîÑ</span>
                                    {% url 'app_updates:updates-detail' pk=upd.type.pk as update_url %}
                                    {% if update_url %}
                                    <a href="{{ update_url }}" class="relation-link">
                                        update: {{ upd.type }}
                                    </a>
                                    {% endif %}
                                    {% endif %}
                                </div>
                                {% endif %}
                                {% endfor %}

                                {% if not column_relations and not update_columns %}
                                <div class="no-relations">‚Äî</div>
                                {% endif %}
                            </div>
                        </td>

                        <td>
                            {% if col.stages_from_json %}
                            <div class="d-flex flex-wrap gap-1">
                                {% for stage in col.stages_from_json %}
                                <span class="stage-badge">{{ stage }}</span>
                                {% endfor %}
                            </div>
                            {% else %}
                            <span class="text-muted">‚Äî</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –ê–Ω–∏–º–∞—Ü–∏—è —Å—Ç—Ä–µ–ª–∫–∏ –∞–∫–∫–æ—Ä–¥–µ–æ–Ω–∞
        const accordionHeaders = document.querySelectorAll('.accordion-header');

        accordionHeaders.forEach(header => {
            const arrow = header.querySelector('.accordion-arrow');
            if (header.classList.contains('collapsed')) {
                arrow.style.transform = 'rotate(-90deg)';
            } else {
                arrow.style.transform = 'rotate(0deg)';
            }
        });

        // –≠–ª–µ–º–µ–Ω—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const exportBtn = document.getElementById('exportCsvBtn');
        const notification = document.getElementById('exportNotification');

        // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        function showNotification(message) {
            if (notification) {
                const messageSpan = notification.querySelector('span:nth-child(2)');
                if (message) {
                    messageSpan.textContent = message;
                }
                notification.style.display = 'flex';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
        }

        // –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ —Ç–∞–±–ª–∏—Ü—ã –≤ CSV
        function exportTableToCSV() {
            try {
                // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –Ω–∞ –≤—Ä–µ–º—è —ç–∫—Å–ø–æ—Ä—Ç–∞
                exportBtn.disabled = true;
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<span class="export-icon">‚è≥</span> –≠–∫—Å–ø–æ—Ä—Ç...';

                const table = document.getElementById('columnsTable');
                const rows = table.querySelectorAll('tr');
                const csvData = [];

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–∫–∏
                const headers = [];
                table.querySelectorAll('thead th').forEach((header, index) => {
                    // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å—Ç–æ–ª–±–µ—Ü "–°–≤—è–∑–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è" (5-–π –∏–Ω–¥–µ–∫—Å)
                    if (index !== 5) {
                        headers.push(header.textContent.trim());
                    }
                });
                csvData.push(headers.join(','));

                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å—Ç—Ä–æ–∫–∏ –¥–∞–Ω–Ω—ã—Ö
                rows.forEach((row, rowIndex) => {
                    if (rowIndex === 0) return;

                    const rowData = [];
                    const cells = row.querySelectorAll('td, th');

                    cells.forEach((cell, cellIndex) => {
                        if (cellIndex === 5) return;

                        let cellText = '';

                        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —è—á–µ–µ–∫
                        if (cell.querySelector('.badge-null, .badge-not-null')) {
                            cellText = cell.querySelector('.badge-null, .badge-not-null').textContent;
                        } else if (cell.querySelector('code')) {
                            cellText = cell.querySelector('code').textContent;
                        } else if (cell.querySelector('.relations-container')) {
                            return;
                        } else if (cell.querySelector('strong') && cellIndex === 4) {
                            const descItems = [];
                            cell.querySelectorAll('div').forEach(div => {
                                descItems.push(div.textContent.trim());
                            });
                            cellText = descItems.join('; ') || cell.textContent.trim();
                        } else if (cell.querySelector('.stage-badge')) {
                            const stages = [];
                            cell.querySelectorAll('.stage-badge').forEach(badge => {
                                stages.push(badge.textContent);
                            });
                            cellText = stages.join(', ');
                        } else {
                            cellText = cell.textContent.trim();
                        }

                        // –û—á–∏—â–∞–µ–º –∏ —ç–∫—Ä–∞–Ω–∏—Ä—É–µ–º
                        cellText = cellText
                            .replace(/"/g, '""')
                            .replace(/[\n\r]/g, ' ')
                            .trim();

                        if (cellText.includes(',') || cellText.includes('"') || cellText.includes('\n')) {
                            cellText = `"${cellText}"`;
                        }

                        if (cellIndex !== 5) {
                            rowData.push(cellText || '‚Äî');
                        }
                    });

                    if (rowData.length > 0) {
                        csvData.push(rowData.join(','));
                    }
                });

                // –°–æ–∑–¥–∞–µ–º CSV —Ñ–∞–π–ª
                const csvContent = csvData.join('\r\n');
                const blob = new Blob(['\uFEFF' + csvContent], {
                    type: 'text/csv;charset=utf-8;'
                });

                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');

                link.href = url;
                link.download = `table_{{ tables.name|slugify }}_columns_${new Date().toISOString().split('T')[0]}.csv`;
                link.style.display = 'none';

                document.body.appendChild(link);
                link.click();

                // –û—á–∏—â–∞–µ–º
                setTimeout(() => {
                    URL.revokeObjectURL(url);
                    document.body.removeChild(link);
                    showNotification('‚úÖ –¢–∞–±–ª–∏—Ü–∞ —É—Å–ø–µ—à–Ω–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–∞ –≤ CSV!');
                    setTimeout(() => {
                        exportBtn.disabled = false;
                        exportBtn.innerHTML = originalText;
                    }, 500);
                }, 100);

            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ CSV:', error);
                showNotification('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.');
                exportBtn.disabled = false;
                exportBtn.innerHTML = '<span class="export-icon">üì•</span> –≠–∫—Å–ø–æ—Ä—Ç CSV';
            }
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∞
        exportBtn.addEventListener('click', exportTableToCSV);

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±—Ä–∞—É–∑–µ—Ä–∞
        if (!window.Blob) {
            exportBtn.disabled = true;
            exportBtn.innerHTML = '<span class="export-icon">‚ùå</span> –ù–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
            showNotification("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —ç–∫—Å–ø–æ—Ä—Ç —Ñ–∞–π–ª–æ–≤");
        }
    });
</script>
{% endblock body %}