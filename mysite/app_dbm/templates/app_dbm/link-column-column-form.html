<!-- templates/app_dbm/link-column-column-form.html -->
{% extends "admin/base_site.html" %}

{% block extrahead %}
{{ block.super }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // Функция для загрузки зависимых данных
    function loadDependentData(url, paramName, paramValue, targetSelect) {
        if (!paramValue) {
            targetSelect.empty().append('<option value="">---------</option>');
            return;
        }

        $.ajax({
            url: url,
            data: { [paramName]: paramValue },
            dataType: 'json',
            success: function(data) {
                targetSelect.empty().append('<option value="">---------</option>');
                $.each(data, function(i, item) {
                    // Универсальное определение отображаемого текста
                    const displayText = item.name || item.schema_name || item.table_name || item.column_name || item.id;
                    targetSelect.append($('<option>', {
                        value: item.id,
                        text: displayText
                    }));
                });
            },
            error: function(xhr, status, error) {
                console.error('Ошибка загрузки данных:', error);
                targetSelect.empty().append('<option value="">Ошибка загрузки</option>');
            }
        });
    }

    // ========== ОСНОВНАЯ КОЛОНКА (main) ==========
    $('#id_main_base').change(function() {
        loadDependentData('/api/schemas/', 'db_id', $(this).val(), $('#id_main_schema'));
        $('#id_main_table, #id_main_column').empty().append('<option value="">---------</option>');
        $('#id_main').val('');
    });

    $('#id_main_schema').change(function() {
        loadDependentData('/api/tables/', 'schema_id', $(this).val(), $('#id_main_table'));
        $('#id_main_column').empty().append('<option value="">---------</option>');
        $('#id_main').val('');
    });

    $('#id_main_table').change(function() {
        loadDependentData('/api/columns/', 'table_id', $(this).val(), $('#id_main_column'));
        $('#id_main').val('');
    });

    $('#id_main_column').change(function() {
        $('#id_main').val($(this).val() || '');
    });

    // ========== ЗАВИСИМАЯ КОЛОНКА (sub) ==========
    $('#id_sub_base').change(function() {
        loadDependentData('/api/schemas/', 'db_id', $(this).val(), $('#id_sub_schema'));
        $('#id_sub_table, #id_sub_column').empty().append('<option value="">---------</option>');
        $('#id_sub').val('');
    });

    $('#id_sub_schema').change(function() {
        loadDependentData('/api/tables/', 'schema_id', $(this).val(), $('#id_sub_table'));
        $('#id_sub_column').empty().append('<option value="">---------</option>');
        $('#id_sub').val('');
    });

    $('#id_sub_table').change(function() {
        loadDependentData('/api/columns/', 'table_id', $(this).val(), $('#id_sub_column'));
        $('#id_sub').val('');
    });

    $('#id_sub_column').change(function() {
        $('#id_sub').val($(this).val() || '');
    });

    // Инициализация: если есть сохранённые значения (при редактировании)
    if ($('#id_main_column').val()) $('#id_main').val($('#id_main_column').val());
    if ($('#id_sub_column').val()) $('#id_sub').val($('#id_sub_column').val());
});
</script>
{% endblock %}

{% block content %}
<form method="post">
    {% csrf_token %}

    <div class="form-row">
        <div class="fieldBox">
            <h3>Основная колонка</h3>
            <div>
                <label for="id_main_base">База данных:</label>
                <select id="id_main_base" name="main_base" class="form-control">
                    <option value="">---------</option>
                    {% for db in dbs %}
                    <option value="{{ db.id }}">{{ db.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="id_main_schema">Схема:</label>
                <select id="id_main_schema" name="main_schema" class="form-control">
                    <option value="">---------</option>
                </select>
            </div>
            <div>
                <label for="id_main_table">Таблица:</label>
                <select id="id_main_table" name="main_table" class="form-control">
                    <option value="">---------</option>
                </select>
            </div>
            <div>
                <label for="id_main_column">Колонка:</label>
                <select id="id_main_column" name="main_column" class="form-control">
                    <option value="">---------</option>
                </select>
            </div>
        </div>

        <div class="fieldBox">
            <h3>Тип связи</h3>
            {{ form.type }}
        </div>

        <div class="fieldBox">
            <h3>Зависимая колонка (опционально)</h3>
            <div>
                <label for="id_sub_base">База данных:</label>
                <select id="id_sub_base" name="sub_base" class="form-control">
                    <option value="">---------</option>
                    {% for db in dbs %}
                    <option value="{{ db.id }}">{{ db.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label for="id_sub_schema">Схема:</label>
                <select id="id_sub_schema" name="sub_schema" class="form-control">
                    <option value="">---------</option>
                </select>
            </div>
            <div>
                <label for="id_sub_table">Таблица:</label>
                <select id="id_sub_table" name="sub_table" class="form-control">
                    <option value="">---------</option>
                </select>
            </div>
            <div>
                <label for="id_sub_column">Колонка:</label>
                <select id="id_sub_column" name="sub_column" class="form-control">
                    <option value="">---------</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Скрытые поля для хранения выбранных колонок -->
    {{ form.main }}
    {{ form.sub }}

    <div class="submit-row">
        <input type="submit" value="Сохранить" class="default">
        <a href="{% url 'admin:app_dbm_linkcolumncolumn_changelist' %}" class="button cancel-link">Отмена</a>
    </div>
</form>
{% endblock %}