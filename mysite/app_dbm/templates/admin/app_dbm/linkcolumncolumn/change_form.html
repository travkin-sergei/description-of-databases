{% extends "admin/change_form.html" %}
{% load static %}

{% block extrastyle %}
{{ block.super }}
<style>
/* === –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: —à—Ä–∏—Ñ—Ç –∫–∞–∫ –≤ –∞–¥–º–∏–Ω–∫–µ, –Ω–æ –ø–æ–ª—è –≤—ã—à–µ –∏ —Å–≤–æ–±–æ–¥–Ω–µ–µ === */
body {
    font-size: 13px !important; /* —Å—Ç–∞–Ω–¥–∞—Ä—Ç Django */
}
.module {
    font-size: 13px !important;
}
h2 {
    font-size: 1.4rem !important; /* 18px */
    margin: 1rem 0 0.8rem 0 !important;
}
h3 {
    font-size: 1.2rem !important; /* 16px */
    margin: 0.9rem 0 0.5rem 0 !important;
    border-bottom: 1px solid #eee;
    padding-bottom: 0.3rem;
}
label {
    font-size: 1.05rem !important; /* 14px */
    font-weight: 600 !important;
    margin-bottom: 0.4rem !important;
}
/* üîë –ö–õ–Æ–ß–ï–í–û–ï –ò–ó–ú–ï–ù–ï–ù–ò–ï: –≤—ã—Å–æ—Ç–∞ –∏ padding –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∑–Ω–∞—á–µ–Ω–∏–π */
select, input[type="text"], input[type="number"] {
    font-size: 13px !important;
    padding: 0.5rem 0.7rem !important;
    min-height: 2.5rem !important; /* ‚Üë –≤—ã—Å–æ—Ç–∞ */
    line-height: 1.4 !important;   /* ‚Üì –º–µ–∂—Å—Ç—Ä–æ—á–∏–µ */
}
option {
    font-size: 13px !important;
    padding: 0.35rem 0.6rem !important;
    white-space: nowrap; /* –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ option */
}
.form-row {
    margin-bottom: 1rem !important;
}
.submit-row {
    margin-top: 1.2rem !important;
}
.submit-row input {
    font-size: 1.1rem !important; /* 14px */
    padding: 0.6rem 1.2rem !important;
    min-height: 2.6rem !important;
}
/* –°–µ—Ç–∫–∞ */
.grid-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.8rem;
    margin-top: 1rem;
}
@media (max-width: 900px) {
    .grid-container {
        grid-template-columns: 1fr;
    }
}
/* –ü–æ–¥—Å–≤–µ—Ç–∫–∞ */
select:focus, input:focus {
    border-color: #4a90e2 !important;
    box-shadow: 0 0 0 0.2rem rgba(74, 144, 226, 0.2) !important;
}
</style>
{% endblock %}

{% block content %}
<div id="content-main">
    <form method="post" enctype="multipart/form-data">{% csrf_token %}
        <div class="module aligned">
            <fieldset class="module aligned">
                <h2>üîó –°–≤—è–∑—å —Å—Ç–æ–ª–±—Ü–æ–≤</h2>
                <div class="grid-container">
                    <!-- Main -->
                    <div>
                        <h3>üîπ –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–æ–ª–±–µ—Ü (main)</h3>
                        <div class="form-row">
                            <label>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (main):</label>
                            {{ adminform.form.main_database }}
                        </div>
                        <div class="form-row">
                            <label>–°—Ö–µ–º–∞ (main):</label>
                            <select id="id_main_schema" name="main_schema" class="vSelect" disabled>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ë–î</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>–¢–∞–±–ª–∏—Ü–∞ (main):</label>
                            <select id="id_main_table" name="main_table" class="vSelect" disabled>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ö–µ–º—É</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>–°—Ç–æ–ª–±–µ—Ü (main):</label>
                            {{ adminform.form.main_column }}
                        </div>
                    </div>

                    <!-- Sub -->
                    <div>
                        <h3>üî∏ –ü–æ–¥—á–∏–Ω—ë–Ω–Ω—ã–π —Å—Ç–æ–ª–±–µ—Ü (sub)</h3>
                        <div class="form-row">
                            <label>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (sub):</label>
                            {{ adminform.form.sub_database }}
                        </div>
                        <div class="form-row">
                            <label>–°—Ö–µ–º–∞ (sub):</label>
                            <select id="id_sub_schema" name="sub_schema" class="vSelect" disabled>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ë–î</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>–¢–∞–±–ª–∏—Ü–∞ (sub):</label>
                            <select id="id_sub_table" name="sub_table" class="vSelect" disabled>
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ö–µ–º—É</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>–°—Ç–æ–ª–±–µ—Ü (sub):</label>
                            {{ adminform.form.sub_column }}
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    {{ adminform.form.type.label_tag }}
                    {{ adminform.form.type }}
                </div>
                <div class="form-row">
                    {{ adminform.form.is_active.label_tag }}
                    {{ adminform.form.is_active }}
                </div>

                {{ adminform.form.main }}
                {{ adminform.form.sub }}
            </fieldset>
        </div>

        <div class="submit-row">
            <input type="submit" value="üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å" class="default" name="_save">
        </div>
    </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
(function($) {
    $(document).ready(function() {
        function fillSelect($select, items, valueKey = 'id', textKey = 'schema') {
            $select.empty().append('<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ ‚Äî</option>');
            if (Array.isArray(items)) {
                items.forEach(item => {
                    // –û–±—Ä–µ–∑–∞–µ–º —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
                    let text = item[textKey];
                    if (text && text.length > 50) {
                        text = text.substring(0, 47) + '...';
                    }
                    $select.append(`<option value="${item[valueKey]}">${text}</option>`);
                });
            }
            $select.prop('disabled', items.length === 0);
        }

        function setupChain(prefix) {
            $(`#id_${prefix}_database`).change(function() {
                const dbId = $(this).val();
                const $schema = $(`#id_${prefix}_schema`)
                    .prop('disabled', true)
                    .empty()
                    .append('<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>');

                if (dbId) {
                    $.getJSON('{% url "app_dbm:get_schemas" %}', { db_id: dbId })
                        .done(data => fillSelect($schema, data, 'id', 'schema'))
                        .fail(() => $schema.empty().append('<option value="">–û—à–∏–±–∫–∞</option>'));
                } else {
                    $schema.empty().append('<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ë–î</option>').prop('disabled', true);
                }
            });

            $(`#id_${prefix}_schema`).change(function() {
                const schemaId = $(this).val();
                const $table = $(`#id_${prefix}_table`)
                    .prop('disabled', true)
                    .empty()
                    .append('<option value="">–ó–∞–≥—Ä—É–∑–∫–∞...</option>');

                if (schemaId) {
                    $.getJSON('{% url "app_dbm:get_tables" %}', { schema_id: schemaId })
                        .done(data => fillSelect($table, data, 'id', 'name'))
                        .fail(() => $table.empty().append('<option value="">–û—à–∏–±–∫–∞</option>'));
                } else {
                    $table.empty().append('<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ö–µ–º—É</option>').prop('disabled', true);
                }
            });

            $(`#id_${prefix}_table`).change(function() {
                const tableId = $(this).val();
                const $column = $(`#id_${prefix}_column`);

                if (tableId && $column.length) {
                    $.getJSON('{% url "app_dbm:get_columns" %}', { table_id: tableId })
                        .done(data => fillSelect($column, data, 'id', 'columns'))
                        .fail(() => $column.empty().append('<option value="">–û—à–∏–±–∫–∞</option>'));
                }
            });
        }

        setupChain('main');
        setupChain('sub');

        setTimeout(() => {
            $('#id_main_database').trigger('change');
            $('#id_sub_database').trigger('change');
        }, 100);
    });
})(django.jQuery || $);
</script>
{% endblock %}