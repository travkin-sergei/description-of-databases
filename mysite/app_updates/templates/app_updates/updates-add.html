<!-- app_updates/templates/app_updates/updates-add.html -->
{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock title %}
{% block body %}
<style>
    .compact-form-card {
        max-width: 800px;
        margin: 2rem auto;
        border: 1px solid #ffcc00;
    }
    .compact-form-card .card-header {
        background-color: #1a1a1a;
        color: #ffcc00;
        padding: 0.75rem 1rem;
    }
</style>

<div class="container py-3">
    <div class="compact-form-card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>{{ title }}</h5>
        </div>
        <div class="card-body p-3">

            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show small mb-3 p-2" role="alert">
                {{ message }}
                <button type="button" class="btn-close p-0" style="font-size: 0.8rem;" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
            {% endif %}

            <form method="post">
                {% csrf_token %}
                {{ formset.management_form }}

                <!-- Основная форма -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        {{ form.name.label_tag }}
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="text-danger">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form.schedule.label_tag }}
                        {{ form.schedule }}
                        {% if form.schedule.errors %}
                        <div class="text-danger">{{ form.schedule.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-3">
                    {{ form.url_input.label_tag }}
                    {{ form.url_input }}
                    {% if form.url_input.errors %}
                    <div class="text-danger">{{ form.url_input.errors }}</div>
                    {% endif %}
                </div>
                <div class="mb-3">
                    {{ form.description.label_tag }}
                    {{ form.description }}
                    {% if form.description.errors %}
                    <div class="text-danger">{{ form.description.errors }}</div>
                    {% endif %}
                </div>

                <!-- Formset: Маппинг столбцов -->
                <h5 class="mt-4 mb-3">Сопоставление столбцов</h5>
                {% if formset.non_form_errors %}
                <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
                {% endif %}


                <!-- Контейнер для строк -->
                <div id="formset-container">
                    {% for form in formset %}
                    <div class="row mb-3 align-items-end formset-row">
                        {{ form.id }}
                        {{ form.DELETE }}
                        <div class="col-md-5">
                            {{ form.main_id.label_tag }}
                            {{ form.main_id }}
                            {% if form.main_id.errors %}
                            <div class="text-danger">{{ form.main_id.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-5">
                            {{ form.sub_id.label_tag }}
                            {{ form.sub_id }}
                            {% if form.sub_id.errors %}
                            <div class="text-danger">{{ form.sub_id.errors }}</div>
                            {% endif %}
                        </div>
                        <div class="col-md-2">
                            {% if form.DELETE %}
                            <label class="form-check-label">
                                {{ form.DELETE }} Удалить
                            </label>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                <!-- Скрытый шаблон новой строки -->
                <div id="empty-form" style="display:none;">
                    <div class="row mb-3 align-items-end formset-row">
                        {{ formset.empty_form.id }}
                        {{ formset.empty_form.DELETE }}
                        <div class="col-md-5">
                            {{ formset.empty_form.main_id.label_tag }}
                            {{ formset.empty_form.main_id }}
                        </div>
                        <div class="col-md-5">
                            {{ formset.empty_form.sub_id.label_tag }}
                            {{ formset.empty_form.sub_id }}
                        </div>
                        <div class="col-md-2">
                            <label class="form-check-label">
                                {{ formset.empty_form.DELETE }} Удалить
                            </label>
                        </div>
                    </div>
                </div>
                <!-- Кнопка добавления -->
                <div class="mb-3">
                    <button type="button" id="add-row" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-plus me-1"></i>Добавить ещё
                    </button>
                </div>
                <div class="d-grid">
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-1"></i>Сохранить метод
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let formCount = {{ formset.total_form_count }};
        const container = document.getElementById('formset-container');
        const addButton = document.getElementById('add-row');
        const emptyForm = document.getElementById('empty-form').innerHTML;

        addButton.addEventListener('click', function () {
            // Заменяем __prefix__ на текущий индекс
            const newForm = emptyForm.replace(/__prefix__/g, formCount);
            container.insertAdjacentHTML('beforeend', newForm);
            formCount++;
            // Обновляем TOTAL_FORMS в management_form
            const totalFormsInput = document.querySelector('#id_linkupdatecol_set-TOTAL_FORMS');
            if (totalFormsInput) {
                totalFormsInput.value = formCount;
            }
        });
    });
</script>
{% endblock body %}