<!-- app_updates/templates/app_updates/updates-add.html -->
{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock title %}
{% block body %}
<style>
    .compact-form-card {
        max-width: 800px;
        margin: 2rem auto;
        border: 1px solid #ffcc00;
    }
    .compact-form-card .card-header {
        background-color: #1a1a1a;
        color: #ffcc00;
        padding: 0.75rem 1rem;
    }
    .chained-selects {
        background-color: #f8f9fa;
        padding: 12px;
        border-radius: 4px;
        margin-top: 8px;
    }
</style>

<div class="container py-3">
    <div class="compact-form-card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>{{ title }}</h5>
        </div>
        <div class="card-body p-3">

            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show small mb-3 p-2" role="alert">
                {{ message }}
                <button type="button" class="btn-close p-0" style="font-size: 0.8rem;" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
            {% endif %}

            <form method="post">
                {% csrf_token %}
                {{ formset.management_form }}

                <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        {{ form.name.label_tag }}
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="text-danger">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form.schedule.label_tag }}
                        {{ form.schedule }}
                        {% if form.schedule.errors %}
                        <div class="text-danger">{{ form.schedule.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-3">
                    {{ form.url_input.label_tag }}
                    {{ form.url_input }}
                    {% if form.url_input.errors %}
                    <div class="text-danger">{{ form.url_input.errors }}</div>
                    {% endif %}
                </div>
                <div class="mb-3">
                    {{ form.description.label_tag }}
                    {{ form.description }}
                    {% if form.description.errors %}
                    <div class="text-danger">{{ form.description.errors }}</div>
                    {% endif %}
                </div>

                <!-- Formset: –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–æ–ª–±—Ü–æ–≤ -->
                <h5 class="mt-4 mb-3">–°–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏–µ —Å—Ç–æ–ª–±—Ü–æ–≤</h5>
                {% if formset.non_form_errors %}
                <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
                {% endif %}

                <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Å—Ç—Ä–æ–∫ -->
                <div id="formset-container">
                    {% for form in formset %}
                    {% with prefix=forloop.counter0 %}
                    <div class="row mb-3 align-items-end formset-row">
                        {{ form.id }}
                        {{ form.DELETE }}

                        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–æ–ª–±–µ—Ü -->
                        <div class="col-md-6">
                            <label>–û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–æ–ª–±–µ—Ü</label>
                            <div class="chained-selects">
                                <select class="form-select form-control-dark db-select"
                                        data-prefix="{{ prefix }}"
                                        data-type="main"
                                        data-url-schemas="{% url 'app_updates:get-schemas' %}"
                                        data-url-tables="{% url 'app_updates:get-tables' %}"
                                        data-url-columns="{% url 'app_updates:get-columns' %}">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É</option>
                                    {% for db in databases %}
                                    <option value="{{ db.id }}">{{ db.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="form-select form-control-dark schema-select mt-2" disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É</option>
                                </select>
                                <select class="form-select form-control-dark table-select mt-2" disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ö–µ–º—É</option>
                                </select>
                                <select class="form-select form-control-dark column-select mt-2" disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É</option>
                                </select>
                            </div>
                            <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–ª–µ Django (—Å–∫—Ä—ã—Ç–æ–µ) -->
                            <div style="display:none;">
                                {{ form.main }}
                            </div>
                        </div>

                        <!-- –î–æ–ø. —Å—Ç–æ–ª–±–µ—Ü -->
                        <div class="col-md-6">
                            <label>–î–æ–ø. —Å—Ç–æ–ª–±–µ—Ü (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <div class="chained-selects">
                                <select class="form-select form-control-dark db-select"
                                        data-prefix="{{ prefix }}"
                                        data-type="sub"
                                        data-url-schemas="{% url 'app_updates:get-schemas' %}"
                                        data-url-tables="{% url 'app_updates:get-tables' %}"
                                        data-url-columns="{% url 'app_updates:get-columns' %}">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É</option>
                                    {% for db in databases %}
                                    <option value="{{ db.id }}">{{ db.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="form-select form-control-dark schema-select mt-2" disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É</option>
                                </select>
                                <select class="form-select form-control-dark table-select mt-2" disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ö–µ–º—É</option>
                                </select>
                                <select class="form-select form-control-dark column-select mt-2" disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É</option>
                                </select>
                            </div>
                            <div style="display:none;">
                                {{ form.sub }}
                            </div>
                        </div>

                        <!-- –£–¥–∞–ª–µ–Ω–∏–µ -->
                        <div class="col-md-12 mt-2">
                            {% if form.DELETE %}
                            <label class="form-check-label">
                                {{ form.DELETE }} –£–¥–∞–ª–∏—Ç—å
                            </label>
                            {% endif %}
                        </div>
                    </div>
                    {% endwith %}
                    {% endfor %}
                </div>

                <!-- –°–∫—Ä—ã—Ç—ã–π —à–∞–±–ª–æ–Ω –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ -->
                <div id="empty-form" style="display:none;">
                    <div class="row mb-3 align-items-end formset-row">
                        {{ formset.empty_form.id }}
                        {{ formset.empty_form.DELETE }}

                        <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–æ–ª–±–µ—Ü -->
                        <div class="col-md-6">
                            <label>–û—Å–Ω–æ–≤–Ω–æ–π —Å—Ç–æ–ª–±–µ—Ü</label>
                            <div class="chained-selects">
                                <select class="form-select form-control-dark db-select"
                                        data-prefix="__prefix__"
                                        data-type="main"
                                        data-url-schemas="{% url 'app_updates:get-schemas' %}"
                                        data-url-tables="{% url 'app_updates:get-tables' %}"
                                        data-url-columns="{% url 'app_updates:get-columns' %}">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É</option>
                                    {% for db in databases %}
                                    <option value="{{ db.id }}">{{ db.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="form-select form-control-dark schema-select mt-2" disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É</option>
                                </select>
                                <select class="form-select form-control-dark table-select mt-2" disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ö–µ–º—É</option>
                                </select>
                                <select class="form-select form-control-dark column-select mt-2" disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É</option>
                                </select>
                            </div>
                            <!-- –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ–µ –ø–æ–ª–µ Django -->
                            <div style="display:none;">
                                {{ formset.empty_form.main }}
                            </div>
                        </div>

                        <!-- –î–æ–ø. —Å—Ç–æ–ª–±–µ—Ü -->
                        <div class="col-md-6">
                            <label>–î–æ–ø. —Å—Ç–æ–ª–±–µ—Ü (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</label>
                            <div class="chained-selects">
                                <select class="form-select form-control-dark db-select"
                                        data-prefix="__prefix__"
                                        data-type="sub"
                                        data-url-schemas="{% url 'app_updates:get-schemas' %}"
                                        data-url-tables="{% url 'app_updates:get-tables' %}"
                                        data-url-columns="{% url 'app_updates:get-columns' %}">
                                    <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É</option>
                                    {% for db in databases %}
                                    <option value="{{ db.id }}">{{ db.name }}</option>
                                    {% endfor %}
                                </select>
                                <select class="form-select form-control-dark schema-select mt-2" disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –±–∞–∑—É</option>
                                </select>
                                <select class="form-select form-control-dark table-select mt-2" disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ö–µ–º—É</option>
                                </select>
                                <select class="form-select form-control-dark column-select mt-2" disabled>
                                    <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É</option>
                                </select>
                            </div>
                            <div style="display:none;">
                                {{ formset.empty_form.sub }}
                            </div>
                        </div>

                        <div class="col-md-12 mt-2">
                            <label class="form-check-label">
                                {{ formset.empty_form.DELETE }} –£–¥–∞–ª–∏—Ç—å
                            </label>
                        </div>
                    </div>
                </div>

                <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
                <div class="mb-3">
                    <button type="button" id="add-row" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-plus me-1"></i>–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë
                    </button>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-1"></i>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –º–µ—Ç–æ–¥
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {

        function initChainedSelects(dbSelect) {
            const prefix = dbSelect.dataset.prefix;
            const type = dbSelect.dataset.type;

            const urlSchemas = dbSelect.dataset.urlSchemas;
            const urlTables  = dbSelect.dataset.urlTables;
            const urlColumns = dbSelect.dataset.urlColumns;

            const wrapper = dbSelect.closest('.chained-selects');
            const schemaSelect = wrapper.querySelector('.schema-select');
            const tableSelect  = wrapper.querySelector('.table-select');
            const columnSelect = wrapper.querySelector('.column-select');

            // ‚úÖ –ò–©–ï–ú –°–ö–†–´–¢–û–ï –ü–û–õ–ï –°–¢–†–û–ì–û –ü–û PREFIX
            const djangoSelect = document.querySelector(
                 `input[name="linkupdatecol_set-${prefix}-${type}"]`
            );

            function reset(select, text) {
                select.innerHTML = `<option value="">${text}</option>`;
                select.disabled = true;
            }

            function fill(select, data, placeholder) {
                reset(select, placeholder);
                data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.textContent = item.schema || item.name || item.columns;
                    select.appendChild(opt);
                });
                select.disabled = false;
            }

            function load(url, params, select, placeholder) {
                fetch(`${url}?${new URLSearchParams(params)}`)
                    .then(r => r.json())
                    .then(data => fill(select, data, placeholder))
                    .catch(console.error);
            }

            // ‚úÖ –í–°–ï–ì–î–ê –°–ò–ù–•–†–û–ù–ò–ó–ò–†–£–ï–ú hidden-–ø–æ–ª–µ
            function syncHidden() {
                if (djangoSelect) {
                    djangoSelect.value = columnSelect.value || '';
                }
            }

            dbSelect.addEventListener('change', () => {
                reset(schemaSelect, '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ö–µ–º—É');
                reset(tableSelect,  '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Å—Ö–µ–º—É');
                reset(columnSelect, '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É');
                syncHidden();

                if (dbSelect.value) {
                    load(urlSchemas, { db_id: dbSelect.value }, schemaSelect, '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ö–µ–º—É');
                }
            });

            schemaSelect.addEventListener('change', () => {
                reset(tableSelect,  '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É');
                reset(columnSelect, '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É');
                syncHidden();

                if (schemaSelect.value) {
                    load(urlTables, { schema_id: schemaSelect.value }, tableSelect, '–í—ã–±–µ—Ä–∏—Ç–µ —Ç–∞–±–ª–∏—Ü—É');
                }
            });

            tableSelect.addEventListener('change', () => {
                reset(columnSelect, '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü');
                syncHidden();

                if (tableSelect.value) {
                    load(urlColumns, { table_id: tableSelect.value }, columnSelect, '–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–æ–ª–±–µ—Ü');
                }
            });

            columnSelect.addEventListener('change', syncHidden);

            // üîÅ –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
            if (djangoSelect && djangoSelect.value) {
                columnSelect.value = djangoSelect.value;
                syncHidden();
            }
        }

        document.querySelectorAll('.db-select').forEach(initChainedSelects);

        let formCount = {{ formset.total_form_count }};
        const container = document.getElementById('formset-container');
        const addButton = document.getElementById('add-row');
        const emptyForm = document.getElementById('empty-form').innerHTML;

        addButton.addEventListener('click', () => {
            const html = emptyForm.replace(/__prefix__/g, formCount);
            container.insertAdjacentHTML('beforeend', html);

            const row = container.lastElementChild;
            row.querySelectorAll('.db-select').forEach(initChainedSelects);

            formCount++;
            document.getElementById('id_linkupdatecol_set-TOTAL_FORMS').value = formCount;
        });
    });
</script>
{% endblock body %}