<!-- app_updates/templates/app_updates/updates-add.html -->
{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock title %}
{% block body %}
<style>
    .compact-form-card {
        max-width: 1200px;
        margin: 2rem auto;
        border: 1px solid #ffcc00;
    }
    .compact-form-card .card-header {
        background-color: #1a1a1a;
        color: #ffcc00;
        padding: 0.75rem 1rem;
    }
    .table-selector {
        background-color: #2a2a2a;
        padding: 15px;
        border-radius: 6px;
        margin-bottom: 20px;
        border: 1px solid #444;
    }
    .main-selector {
        border-left: 4px solid #ffcc00;
    }
    .sub-selector {
        border-left: 4px solid #6c757d;
    }
    .table-selector h6 {
        color: #ffcc00;
        margin-bottom: 15px;
        font-size: 0.95rem;
        padding-bottom: 8px;
        border-bottom: 1px solid #555;
    }
    .sub-selector h6 {
        color: #6c757d;
    }
    .column-selectors {
        background-color: #f8f9fa;
        padding: 12px;
        border-radius: 4px;
        margin-top: 8px;
    }
    .selector-group {
        margin-bottom: 15px;
    }
    .selector-group label {
        font-weight: 500;
        color: #e0e0e0;
        margin-bottom: 5px;
        display: block;
    }
    .selector-group select {
        width: 100%;
    }
</style>
<div class="container py-3">
    <div class="compact-form-card">
        <div class="card-header">
            <h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>{{ title }}</h5>
        </div>
        <div class="card-body p-3">

            {% if messages %}
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show small mb-3 p-2" role="alert">
                {{ message }}
                <button type="button" class="btn-close p-0" style="font-size: 0.8rem;" data-bs-dismiss="alert"></button>
            </div>
            {% endfor %}
            {% endif %}

            <form method="post">
                {% csrf_token %}
                {{ formset.management_form }}

                <!-- Основная форма -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        {{ form.name.label_tag }}
                        {{ form.name }}
                        {% if form.name.errors %}
                        <div class="text-danger">{{ form.name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="col-md-6">
                        {{ form.schedule.label_tag }}
                        {{ form.schedule }}
                        {% if form.schedule.errors %}
                        <div class="text-danger">{{ form.schedule.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="mb-3">
                    {{ form.url_input.label_tag }}
                    {{ form.url_input }}
                    {% if form.url_input.errors %}
                    <div class="text-danger">{{ form.url_input.errors }}</div>
                    {% endif %}
                </div>
                <div class="mb-3">
                    {{ form.description.label_tag }}
                    {{ form.description }}
                    {% if form.description.errors %}
                    <div class="text-danger">{{ form.description.errors }}</div>
                    {% endif %}
                </div>

                <!-- ДВЕ КОЛОНКИ -->
                <div class="row">
                    <!-- ЛЕВАЯ КОЛОНКА: Основная таблица -->
                    <div class="col-md-6">
                        <div class="table-selector main-selector">
                            <h6><i class="fas fa-database me-2"></i>ОСНОВНАЯ ТАБЛИЦА</h6>
                            <div class="selector-group">
                                <label for="main-db-select">База данных</label>
                                <select class="form-select form-control-dark" id="main-db-select">
                                    <option value="">Выберите базу</option>
                                    {% for db in databases %}
                                    <option value="{{ db.id }}">{{ db.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="selector-group">
                                <label for="main-schema-select">Схема</label>
                                <select class="form-select form-control-dark" id="main-schema-select" disabled>
                                    <option value="">Сначала выберите базу</option>
                                </select>
                            </div>
                            <div class="selector-group">
                                <label for="main-table-select">Таблица</label>
                                <select class="form-select form-control-dark" id="main-table-select" disabled>
                                    <option value="">Сначала выберите схему</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- ПРАВАЯ КОЛОНКА: Дополнительная таблица -->
                    <div class="col-md-6">
                        <div class="table-selector sub-selector">
                            <h6><i class="fas fa-database me-2"></i>ДОПОЛНИТЕЛЬНАЯ ТАБЛИЦА (опционально)</h6>
                            <div class="selector-group">
                                <label for="sub-db-select">База данных</label>
                                <select class="form-select form-control-dark" id="sub-db-select">
                                    <option value="">Выберите базу</option>
                                    {% for db in databases %}
                                    <option value="{{ db.id }}">{{ db.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="selector-group">
                                <label for="sub-schema-select">Схема</label>
                                <select class="form-select form-control-dark" id="sub-schema-select" disabled>
                                    <option value="">Сначала выберите базу</option>
                                </select>
                            </div>
                            <div class="selector-group">
                                <label for="sub-table-select">Таблица</label>
                                <select class="form-select form-control-dark" id="sub-table-select" disabled>
                                    <option value="">Сначала выберите схему</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Formset: Маппинг столбцов -->
                {% if formset.non_form_errors %}
                <div class="alert alert-danger">{{ formset.non_form_errors }}</div>
                {% endif %}

                <!-- Контейнер для строк -->
                <div id="formset-container">
                    {% for form in formset %}
                    {% with prefix=forloop.counter0 %}
                    <div class="row mb-3 align-items-end formset-row">
                        {{ form.id }}
                        <!-- Основной столбец -->
                        <div class="col-md-6">
                            <div class="column-selectors">
                                <select class="form-select form-control-dark main-column-select"
                                        data-prefix="{{ prefix }}"
                                        data-type="main">
                                    <option value="">Выберите столбец</option>
                                </select>
                            </div>
                            <!-- Стандартное поле Django (скрытое) -->
                            <div style="display:none;">
                                {{ form.main }}
                            </div>
                        </div>

                        <!-- Доп. столбец -->
                        <div class="col-md-6">
                            <div class="column-selectors">
                                <select class="form-select form-control-dark sub-column-select"
                                        data-prefix="{{ prefix }}"
                                        data-type="sub">
                                    <option value="">Выберите столбец</option>
                                </select>
                            </div>
                            <div style="display:none;">
                                {{ form.sub }}
                            </div>
                        </div>

                    </div>
                    {% endwith %}
                    {% endfor %}
                </div>

                <!-- Скрытый шаблон новой строки -->
                <div id="empty-form" style="display:none;">
                    <div class="row mb-3 align-items-end formset-row">
                        {{ formset.empty_form.id }}
                        <!-- Основной столбец -->
                        <div class="col-md-6">
                            <div class="column-selectors">
                                <select class="form-select form-control-dark main-column-select"
                                        data-prefix="__prefix__"
                                        data-type="main">
                                    <option value="">Выберите столбец</option>
                                </select>
                            </div>
                            <!-- Стандартное поле Django -->
                            <div style="display:none;">
                                {{ formset.empty_form.main }}
                            </div>
                        </div>

                        <!-- Доп. столбец -->
                        <div class="col-md-6">
                            <div class="column-selectors">
                                <select class="form-select form-control-dark sub-column-select"
                                        data-prefix="__prefix__"
                                        data-type="sub">
                                    <option value="">Выберите столбец</option>
                                </select>
                            </div>
                            <div style="display:none;">
                                {{ formset.empty_form.sub }}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Кнопка добавления -->
                <div class="mb-3">
                    <button type="button" id="add-row" class="btn btn-outline-secondary btn-sm">
                        <i class="fas fa-plus me-1"></i>Добавить ещё
                    </button>
                </div>

                <div class="d-grid">
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-save me-1"></i>Сохранить метод
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const urls = {
            schemas: "{% url 'app_updates:get-schemas' %}",
            tables: "{% url 'app_updates:get-tables' %}",
            columns: "{% url 'app_updates:get-columns' %}"
        };

        const mainDbSelect = document.getElementById('main-db-select');
        const mainSchemaSelect = document.getElementById('main-schema-select');
        const mainTableSelect = document.getElementById('main-table-select');

        const subDbSelect = document.getElementById('sub-db-select');
        const subSchemaSelect = document.getElementById('sub-schema-select');
        const subTableSelect = document.getElementById('sub-table-select');

        const mainColumnsCache = {};
        const subColumnsCache = {};

        // === Вспомогательные функции ===
        function reset(select, placeholder) {
            select.innerHTML = `<option value="">${placeholder}</option>`;
            select.disabled = true;
        }

        function fill(select, data, placeholder) {
            select.innerHTML = `<option value="">${placeholder}</option>`;
            if (data && data.length) {
                data.forEach(item => {
                    const opt = document.createElement('option');
                    opt.value = item.id;
                    opt.textContent = item.name || item.schema || item.table || item.columns;
                    select.appendChild(opt);
                });
            }
            select.disabled = false;
        }

        async function load(url, params) {
            const response = await fetch(`${url}?${new URLSearchParams(params)}`);
            if (!response.ok) throw new Error('Ошибка загрузки');
            return await response.json();
        }

        // === Обновление селектов столбцов ===
        function updateColumnSelects() {
            const mainTableId = mainTableSelect.value;
            const subTableId = subTableSelect.value;

            // Обновляем все main-column-select
            document.querySelectorAll('.main-column-select').forEach(select => {
                const prefix = select.dataset.prefix;
                const hiddenInput = document.querySelector(`input[name="linkupdatecol_set-${prefix}-main"]`);
                if (mainTableId && mainColumnsCache[mainTableId]) {
                    fill(select, mainColumnsCache[mainTableId], 'Выберите столбец');
                    if (hiddenInput && hiddenInput.value) select.value = hiddenInput.value;
                } else {
                    reset(select, 'Выберите столбец');
                }
            });

            // Обновляем все sub-column-select
            document.querySelectorAll('.sub-column-select').forEach(select => {
                const prefix = select.dataset.prefix;
                const hiddenInput = document.querySelector(`input[name="linkupdatecol_set-${prefix}-sub"]`);
                if (subTableId && subColumnsCache[subTableId]) {
                    fill(select, subColumnsCache[subTableId], 'Выберите столбец');
                    if (hiddenInput && hiddenInput.value) select.value = hiddenInput.value;
                } else {
                    reset(select, 'Выберите столбец');
                }
            });
        }

        // === Обработчики для MAIN ===
        mainDbSelect.addEventListener('change', async () => {
            reset(mainSchemaSelect, 'Сначала выберите базу');
            reset(mainTableSelect, 'Сначала выберите схему');
            Object.keys(mainColumnsCache).forEach(k => delete mainColumnsCache[k]);
            updateColumnSelects();

            if (mainDbSelect.value) {
                try {
                    const schemas = await load(urls.schemas, { db_id: mainDbSelect.value });
                    fill(mainSchemaSelect, schemas, 'Выберите схему');
                } catch (e) {
                    console.error('Ошибка загрузки схем:', e);
                    reset(mainSchemaSelect, 'Ошибка загрузки');
                }
            }
        });

        mainSchemaSelect.addEventListener('change', async () => {
            reset(mainTableSelect, 'Сначала выберите схему');
            Object.keys(mainColumnsCache).forEach(k => delete mainColumnsCache[k]);
            updateColumnSelects();

            if (mainSchemaSelect.value) {
                try {
                    const tables = await load(urls.tables, { schema_id: mainSchemaSelect.value });
                    fill(mainTableSelect, tables, 'Выберите таблицу');
                } catch (e) {
                    console.error('Ошибка загрузки таблиц:', e);
                    reset(mainTableSelect, 'Ошибка загрузки');
                }
            }
        });

        mainTableSelect.addEventListener('change', async () => {
            updateColumnSelects();
            if (mainTableSelect.value && !mainColumnsCache[mainTableSelect.value]) {
                try {
                    const columns = await load(urls.columns, { table_id: mainTableSelect.value });
                    mainColumnsCache[mainTableSelect.value] = columns;
                    updateColumnSelects();
                } catch (e) {
                    console.error('Ошибка загрузки столбцов:', e);
                    document.querySelectorAll('.main-column-select').forEach(s => reset(s, 'Ошибка'));
                }
            }
        });

        // === Обработчики для SUB ===
        subDbSelect.addEventListener('change', async () => {
            reset(subSchemaSelect, 'Сначала выберите базу');
            reset(subTableSelect, 'Сначала выберите схему');
            Object.keys(subColumnsCache).forEach(k => delete subColumnsCache[k]);
            updateColumnSelects();

            if (subDbSelect.value) {
                try {
                    const schemas = await load(urls.schemas, { db_id: subDbSelect.value });
                    fill(subSchemaSelect, schemas, 'Выберите схему');
                } catch (e) {
                    console.error('Ошибка загрузки схем (sub):', e);
                    reset(subSchemaSelect, 'Ошибка загрузки');
                }
            }
        });

        subSchemaSelect.addEventListener('change', async () => {
            reset(subTableSelect, 'Сначала выберите схему');
            Object.keys(subColumnsCache).forEach(k => delete subColumnsCache[k]);
            updateColumnSelects();

            if (subSchemaSelect.value) {
                try {
                    const tables = await load(urls.tables, { schema_id: subSchemaSelect.value });
                    fill(subTableSelect, tables, 'Выберите таблицу');
                } catch (e) {
                    console.error('Ошибка загрузки таблиц (sub):', e);
                    reset(subTableSelect, 'Ошибка загрузки');
                }
            }
        });

        subTableSelect.addEventListener('change', async () => {
            updateColumnSelects();
            if (subTableSelect.value && !subColumnsCache[subTableSelect.value]) {
                try {
                    const columns = await load(urls.columns, { table_id: subTableSelect.value });
                    subColumnsCache[subTableSelect.value] = columns;
                    updateColumnSelects();
                } catch (e) {
                    console.error('Ошибка загрузки столбцов (sub):', e);
                    document.querySelectorAll('.sub-column-select').forEach(s => reset(s, 'Ошибка'));
                }
            }
        });

        // === Синхронизация скрытых полей при изменении селектов ===
        function bindColumnSelectEvents() {
            document.querySelectorAll('.main-column-select, .sub-column-select').forEach(select => {
                const prefix = select.dataset.prefix;
                const type = select.dataset.type; // 'main' или 'sub'
                const hiddenInput = document.querySelector(`input[name="linkupdatecol_set-${prefix}-${type}"]`);

                if (hiddenInput) {
                    // Устанавливаем начальное значение
                    if (hiddenInput.value) select.value = hiddenInput.value;

                    // Синхронизируем при изменении
                    select.addEventListener('change', () => {
                        hiddenInput.value = select.value || '';
                    });
                }
            });
        }

        // Инициализация существующих строк
        bindColumnSelectEvents();

        // === Добавление новых строк ===
        let formCount = {{ formset.total_form_count }};
        const container = document.getElementById('formset-container');
        const addButton = document.getElementById('add-row');
        const totalFormsInput = document.getElementById('id_linkupdatecol_set-TOTAL_FORMS');
        const emptyFormHtml = document.getElementById('empty-form').innerHTML;

        addButton.addEventListener('click', function () {
            const newHtml = emptyFormHtml.replace(/__prefix__/g, formCount);
            container.insertAdjacentHTML('beforeend', newHtml);

            // Обновляем селекты (если таблицы уже выбраны)
            updateColumnSelects();

            // Привязываем события к новым селектам
            bindColumnSelectEvents();

            // Обновляем счётчик
            formCount++;
            totalFormsInput.value = formCount;

            // Прокрутка
            container.lastElementChild.scrollIntoView({ behavior: 'smooth' });
        });
    });
</script>
{% endblock %}