{% extends 'base.html' %}

{% block title %}{{ update_method.name }} - Метод обновления{% endblock title %}

{% block body %}
<style>
    .table-custom thead {
        background-color: #1a1a1a;
        color: #ffcc00;
    }

    .table-custom thead th {
        border-bottom: 2px solid #ffcc00;
    }

    .table-custom tbody tr:nth-child(even) {
        background-color: #fffae6;
    }

    .table-custom tbody tr:hover {
        background-color: #fff9e6;
    }

    .badge-active {
        background-color: #ffcc00;
        color: #1a1a1a;
        font-weight: 600;
    }

    .badge-inactive {
        background-color: #6c757d;
        color: white;
        font-weight: 600;
    }

    .btn-yellow {
        background-color: #ffcc00;
        color: #1a1a1a;
        border: none;
        font-weight: 600;
    }

    .btn-yellow:hover {
        background-color: #e6b800;
        color: #1a1a1a;
    }

    .btn-outline-yellow {
        border-color: #ffcc00;
        color: #1a1a1a;
    }

    .btn-outline-yellow:hover {
        background-color: #ffcc00;
        color: #1a1a1a;
    }

    .card-header-custom {
        background-color: #1a1a1a;
        color: #ffcc00;
        border-bottom: 2px solid #ffcc00;
    }

    .card-custom {
        border: 1px solid #dee2e6;
        border-top: 3px solid #ffcc00;
    }

    .badge-destination {
        background-color: rgba(0, 123, 255, 0.1);
        color: #0069d9;
        font-weight: 600;
    }

    .badge-source {
        background-color: rgba(255, 204, 0, 0.1);
        color: #b38f00;
        font-weight: 600;
    }

    .text-yellow {
        color: #ffcc00;
    }

    a {
        color: #1a1a1a;
    }

    a:hover {
        color: #ffcc00;
    }
</style>

<div class="container py-4">
    <!-- Заголовок и основная информация -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-2">
                <i class="fas fa-sync-alt text-yellow mr-2"></i>
                {{ update_method.name }}
            </h1>
        </div>
        <a href="{% url 'app_updates:updates-list' %}" class="btn btn-outline-yellow">
            <i class="fas fa-arrow-left mr-2"></i>Назад
        </a>
    </div>

    <!-- Детали метода обновления -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card card-custom">
                <div class="card-header card-header-custom py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle mr-2"></i>Описание {{ update_method.name }}
                    </h5>
                </div>
                <div class="card-body">
                    {% if update_method.description %}
                    <p class="card-text">{{ update_method.description|linebreaks }}</p>
                    {% else %}
                    <p class="text-muted font-italic">Описание отсутствует</p>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card card-custom h-100">
                <div class="card-header card-header-custom py-3">
                    <h5 class="mb-0">
                        <i class="fas fa-cogs mr-2"></i>Расписание
                    </h5>
                </div>
                <div class="card-body d-flex flex-column align-items-center justify-content-center text-center">
                    {% if update_method.schedule %}
                    <div class="mb-2">
                        <code class="bg-light p-2 rounded">{{ update_method.schedule }}</code>
                    </div>
                    {% if next_run %}
                    <div>
                        <small class="text-muted">Следующий запуск:</small>
                        <strong>{{ next_run|date:"Y-M-d H:i:s" }}</strong>
                    </div>
                    {% endif %}
                    {% else %}
                    <em class="text-muted">Расписание не задано</em>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    <!-- Связанные таблицы -->
    {% if related_links %}
    <div class="card card-custom mb-4">
        <div class="card-header card-header-custom py-3">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-table mr-2"></i>
                    Связанные таблицы
                </h5>
                <span class="badge badge-active">{{ related_links|length }}</span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-custom table-hover mb-0">
                    <thead>
                    <tr>
                        <th width="5%" class="text-center">#</th>
                        <th>Таблица</th>
                        <th>Столбец</th>
                        <th width="8%" class="text-center">PK</th>
                        <th width="8%" class="text-center">PK</th>
                        <th>Столбец</th>
                        <th>Таблица</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for link in related_links %}
                    <tr>
                        <td class="text-center text-muted">{{ forloop.counter }}</td>
                        <!-- Назначение -->
                        <td>
                            {% if link.main.table %}
                            <a href="{% url 'app_dbm:tables-detail' pk=link.main.table.pk %}"
                               class="text-decoration-none">
                                {{ link.main.table.schema.base.name|default:"—" }}.
                                {{ link.main.table.schema.schema|default:"—" }}.
                                {{ link.main.table.name }}
                            </a>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            <code class="bg-light">{{ link.main.columns|default:"—" }}</code>
                        </td>
                        <td class="text-center">
                            {% if link.main.pk %}
                            <span class="badge bg-success">{{ link.main.pk }}</span>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <!-- Источник -->
                        <td class="text-center">
                            {% if link.sub.pk %}
                            <span class="badge bg-success">{{ link.sub.pk }}</span>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                        <td>
                            <code class="bg-light">{{ link.sub.columns|default:"—" }}</code>
                        </td>
                        <td>
                            {% if link.sub.table %}
                            <a href="{% url 'app_dbm:tables-detail' pk=link.sub.table.pk %}"
                               class="text-decoration-none">
                                {{ link.sub.table.schema.base.name|default:"—" }}.
                                {{ link.sub.table.schema.schema|default:"—" }}.
                                {{ link.sub.table.name }}
                            </a>
                            {% else %}
                            <span class="text-muted">—</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    {% else %}
    <div class="card card-custom mb-4">
        <div class="card-body text-center py-5">
            <i class="fas fa-unlink fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">Нет связанных таблиц</h5>
            <p class="text-muted">Для этого метода обновления не настроены связи</p>
        </div>
    </div>
    {% endif %}
    <!-- Действия -->
    <div class="d-flex justify-content-between mt-4">
        <a href="{% url 'app_updates:updates-list' %}" class="btn btn-outline-yellow">
            <i class="fas fa-arrow-left mr-2"></i>К списку методов
        </a>
        <div class="btn-group">
            {% if perms.app_updates.change_updatemethod %}
            <button class="btn btn-yellow">
                <i class="fas fa-edit mr-2"></i>Редактировать
            </button>
            {% endif %}
            {% if perms.app_updates.delete_updatemethod %}
            <button class="btn btn-outline-danger">
                <i class="fas fa-trash mr-2"></i>Удалить
            </button>
            {% endif %}
        </div>
    </div>
</div>
{% endblock body %}