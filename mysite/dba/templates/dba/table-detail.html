{% extends 'base.html' %}
{% block title %}{{ title }}{% endblock title %}
{% block body %}
{% include 'inc/_paginator.html' %}
<div class="container mt-12">
    <div class="card">
        <div class="card-body">
            <p class="card-title">{{ table.schema.base.table_catalog }}/{{ table.schema }}</p>
            <h2 class="card-title">
                {{ table.table_name|safe }}
                {% if table.names.all %}
                    <div class="mt-2">
                        {% for name in table.names.all %}
                            <span class="badge bg-secondary me-1">
                                {{ name.language.code|upper }}: {{ name.name }}
                            </span>
                        {% endfor %}
                    </div>
                {% endif %}
            </h2>

            <h3 class="card-title mt-4">Описание</h3>
            <p class="card-text">{{ table.table_com|safe|default:"Нет описания" }}</p>

            <h3 class="card-title mt-4">Обновление</h3>
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th scope="col">№</th>
                        <th scope="col">Название</th>
                        <th scope="col">Тип</th>
                        <th scope="col">Активно</th>
                        <th scope="col">Расписание</th>
                    </tr>
                </thead>
                <tbody>
                    {% for update in object_list %}
                    <tr>
                        <th scope="row">{{ forloop.counter }}</th>
                        <td><a href="#">{{ update.name }}</a></td>
                        <td>{{ update.type }}</td>
                        <td>{% if update.is_active %}Да{% else %}Нет{% endif %}</td>
                        <td>{{ update.schedule }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h3 class="card-title mt-4">DDL</h3>
            <p><a href="#" class="btn btn-outline-primary">Просмотреть DDL</a></p>

            <h3 class="card-title mt-4">Сервисы</h3>
            <div class="d-flex flex-wrap gap-2">
                {% for service_item in service %}
                <a href="{% url 'dba:service_id' pk=service_item.pk %}"
                   class="btn btn-sm btn-outline-info">
                    {{ service_item.service }}
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div class="container mt-4">
    <div class="card">
        <div class="card-header">
            <h3 class="mb-0">
                Состав таблицы: {{ table.schema.base.table_catalog }} →
                {{ table.schema }}.{{ table.table_name }}
            </h3>
        </div>
        <div class="card-body">
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th width="5%">№</th>
                        <th width="5%">ID</th>
                        <th width="10%">Дата</th>
                        <th width="10%">Колонка</th>
                        <th width="10%">Тип</th>
                        <th width="20%">Описание</th>
                        <th width="5%">NULL</th>
                        <th width="10%">По умолчанию</th>
                        <th width="10%">Auto</th>
                        <th width="15%">Связи</th>
                        <th width="10%">Этапы</th>
                    </tr>
                </thead>
                <tbody>
                    {% for col in column %}
                    <tr>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ col.pk }}</td>
                        <td>{{ col.date_create|date:"Y-m-d" }}</td>
                        <td><strong>{{ col.column_name }}</strong></td>
                        <td>{{ col.data_type }}</td>
                        <td>{{ col.column_com|default:"-" }}</td>
                        <td>{{ col.is_nullable }}</td>
                        <td>{{ col.column_default|default:"-" }}</td>
                        <td>{{ col.is_auto|default:"-" }}</td>
                        <td>
                            {% for rel in column_column %}
                                {% if col.pk == rel.main.pk and rel.sub.table %}
                                <div class="mb-1">
                                    <a href="{% url 'dba:table_id' pk=rel.sub.table.pk %}">
                                        {{ rel.type }} → {{ rel.sub.table.table_name }}.{{ rel.sub.column_name }}
                                    </a>
                                    {% if rel.sub.table.names.all %}
                                    <div class="text-muted small">
                                        {% for name in rel.sub.table.names.all %}
                                        <span>[{{ name.language.code }}: {{ name.name }}]</span>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                </div>
                                {% endif %}
                            {% endfor %}
                        </td>
                        <td>
                            {% for stg in stage %}
                                {% if col.pk == stg.column_id %}
                                <span class="badge bg-light text-dark me-1">{{ stg.stage.type }}</span>
                                {% endif %}
                            {% endfor %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}